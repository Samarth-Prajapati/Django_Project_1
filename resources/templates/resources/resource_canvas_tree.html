{% extends 'base.html' %} {% load static %} {% block title %}Resource Tree
Visualization{% endblock %} {% block content %}
<style>
  .canvas-container {
    position: relative;
    width: 100%;
    height: 80vh;
    overflow: hidden;
    cursor: grab;
    background: radial-gradient(circle at center, #f8f9fa 0%, #e9ecef 100%);
    box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    margin-top: 20px;
  }

  .canvas-container.dragging {
    cursor: grabbing;
  }

  #treeCanvas {
    display: block;
    border-radius: 8px;
  }

  .controls-panel {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    width: 280px;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    z-index: 1000;
  }

  .controls-panel h5 {
    color: #2c3e50;
    margin-bottom: 12px;
    font-weight: 700;
    font-size: 1em;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .control-group {
    margin-bottom: 15px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  .control-group:last-child {
    border-bottom: none;
  }

  .control-group label {
    display: block;
    margin-bottom: 6px;
    font-size: 0.8em;
    color: #555;
    font-weight: 600;
  }

  .btn-control {
    padding: 6px 12px;
    margin: 2px;
    border-radius: 6px;
    border: none;
    font-size: 0.75em;
    font-weight: 600;
    transition: all 0.3s ease;
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    cursor: pointer;
  }

  .btn-control:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    background: linear-gradient(45deg, #764ba2, #667eea);
  }

  .btn-control.active {
    background: linear-gradient(45deg, #4caf50, #45a049);
  }

  .zoom-controls {
    display: flex;
    gap: 8px;
    align-items: center;
    justify-content: center;
  }

  .zoom-level {
    font-size: 0.8em;
    color: #666;
    min-width: 45px;
    text-align: center;
    font-weight: 600;
  }

  .search-box {
    position: relative;
  }

  .search-box input,
  .search-box select {
    width: 100%;
    padding: 8px 32px 8px 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 0.8em;
    transition: all 0.3s ease;
    background: white;
  }

  .search-box input:focus,
  .search-box select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .search-box select {
    padding-right: 12px;
    cursor: pointer;
  }

  .search-box i {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
  }

  .filter-group {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 8px;
  }

  .filter-btn {
    padding: 4px 8px;
    font-size: 0.7em;
    border-radius: 4px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .filter-btn.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .legend {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    width: 280px;
    z-index: 1000;
  }

  .legend h6 {
    color: #2c3e50;
    margin-bottom: 12px;
    font-weight: 700;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .legend-section {
    margin-bottom: 12px;
  }

  .legend-section h7 {
    font-size: 0.75em;
    color: #666;
    font-weight: 600;
    margin-bottom: 6px;
    display: block;
  }

  .legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    padding: 4px 6px;
    border-radius: 4px;
    transition: background-color 0.2s;
    font-size: 0.75em;
  }

  .legend-item:hover {
    background-color: rgba(52, 152, 219, 0.1);
  }

  .legend-icon {
    width: 14px;
    height: 14px;
    margin-right: 8px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    color: white;
    flex-shrink: 0;
  }

  .info-panel {
    position: absolute;
    top: 50%;
    right: 10px;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    max-width: 320px;
    display: none;
    z-index: 1001;
  }

  .info-panel h6 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-weight: 700;
    font-size: 1em;
  }

  .info-item {
    margin-bottom: 8px;
    font-size: 0.85em;
    display: flex;
    justify-content: space-between;
  }

  .loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 1000;
    border-radius: 8px;
  }

  .spinner {
    width: 60px;
    height: 60px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  .home-button {
    position: absolute;
    top: 10px;
    right: 300px;
    background: linear-gradient(45deg, #ff6b6b, #ee5a52);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.85em;
    transition: all 0.3s ease;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .home-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
    color: white;
    text-decoration: none;
  }

  .stats-summary {
    background: rgba(102, 126, 234, 0.1);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
    font-size: 0.8em;
  }

  .stats-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }

  .performance-info {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background: rgba(255, 255, 255, 0.9);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.7em;
    color: #666;
    z-index: 1000;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .controls-panel,
    .legend {
      width: 250px;
      padding: 10px;
    }

    .home-button {
      padding: 6px 12px;
      font-size: 0.8em;
      right: 260px;
    }
  }
</style>

<div class="container-fluid mt-3">
  <div class="row">
    <div class="col-12">
      <div class="canvas-container" id="canvasContainer">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
          <div class="spinner"></div>
          <p style="margin-top: 20px; color: #666; font-weight: 600">
            Loading resource tree data...
          </p>
          <p style="font-size: 0.8em; color: #999">
            Please wait while we fetch and process your resource data
          </p>
        </div>

        <!-- Main Canvas -->
        <canvas id="treeCanvas"></canvas>

        <!-- Home Button -->
        <a href="{% url 'projects:dashboard_home' %}" class="home-button">
          <i class="fas fa-home"></i> Back to Dashboard
        </a>

        <!-- Controls Panel -->
        <div class="controls-panel">
          <h5><i class="fas fa-sliders-h"></i> Tree Controls</h5>

          <!-- Stats Summary -->
          <div class="stats-summary" id="statsSummary">
            <div class="stats-item">
              <span>Total Resources:</span>
              <span id="totalResources">-</span>
            </div>
            <div class="stats-item">
              <span>Total Projects:</span>
              <span id="totalProjects">-</span>
            </div>
            <div class="stats-item">
              <span>Nodes Visible:</span>
              <span id="visibleNodes">-</span>
            </div>
          </div>

          <!-- Resource Selection -->
          <div class="control-group">
            <label><i class="fas fa-user-circle"></i> Select Resource</label>
            <div class="search-box">
              <select id="resourceSelect" class="form-select">
                <option value="">All Resources</option>
              </select>
            </div>
          </div>

          <!-- Search -->
          <div class="control-group">
            <label><i class="fas fa-search"></i> Search Resources</label>
            <div class="search-box">
              <input
                type="text"
                id="searchInput"
                placeholder="Type resource or project name..."
              />
              <i class="fas fa-search"></i>
            </div>
          </div>

          <!-- Filters -->
          <div class="control-group">
            <label><i class="fas fa-filter"></i> Filter by Role</label>
            <div class="filter-group">
              <button class="filter-btn active" data-filter="all">All</button>
              <button class="filter-btn" data-filter="poc">POC</button>
              <button class="filter-btn" data-filter="responsible">
                Responsible
              </button>
              <button class="filter-btn" data-filter="assigned">
                Assigned
              </button>
            </div>
          </div>

          <!-- Zoom Controls -->
          <div class="control-group">
            <label><i class="fas fa-search-plus"></i> Zoom Level</label>
            <div class="zoom-controls">
              <button class="btn-control" id="zoomOut">
                <i class="fas fa-minus"></i>
              </button>
              <span class="zoom-level" id="zoomLevel">100%</span>
              <button class="btn-control" id="zoomIn">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>

          <!-- View Controls -->
          <div class="control-group">
            <label><i class="fas fa-eye"></i> View Options</label>
            <div>
              <button class="btn-control" id="centerView">
                <i class="fas fa-crosshairs"></i> Center
              </button>
              <button class="btn-control" id="fitView">
                <i class="fas fa-expand-arrows-alt"></i> Fit All
              </button>
            </div>
            <div style="margin-top: 8px">
              <button class="btn-control" id="collapseAll">
                <i class="fas fa-compress-alt"></i> Collapse
              </button>
              <button class="btn-control" id="expandAll">
                <i class="fas fa-expand-alt"></i> Expand
              </button>
            </div>
          </div>

          <!-- Layout Controls -->
          <div class="control-group">
            <label><i class="fas fa-sitemap"></i> Layout</label>
            <div>
              <button class="btn-control active" id="layoutVertical">
                <i class="fas fa-arrows-alt-v"></i> Vertical
              </button>
              <button class="btn-control" id="layoutHorizontal">
                <i class="fas fa-arrows-alt-h"></i> Horizontal
              </button>
            </div>
          </div>

          <!-- Animation Controls -->
          <div class="control-group">
            <label><i class="fas fa-magic"></i> Animation</label>
            <div>
              <button class="btn-control active" id="toggleAnimation">
                <i class="fas fa-play"></i> Enabled
              </button>
              <button class="btn-control" id="resetView">
                <i class="fas fa-undo"></i> Reset
              </button>
            </div>
          </div>
        </div>

        <!-- Legend -->
        <div class="legend">
          <h6><i class="fas fa-info-circle"></i> Legend</h6>

          <div class="legend-section">
            <h7>Node Types</h7>
            <div class="legend-item">
              <div
                class="legend-icon"
                style="background: linear-gradient(45deg, #667eea, #764ba2)"
              >
                <i class="fas fa-user"></i>
              </div>
              <span>Resource</span>
            </div>
            <div class="legend-item">
              <div
                class="legend-icon"
                style="background: linear-gradient(45deg, #f093fb, #f5576c)"
              >
                <i class="fas fa-crown"></i>
              </div>
              <span>POC Projects</span>
            </div>
            <div class="legend-item">
              <div
                class="legend-icon"
                style="background: linear-gradient(45deg, #4facfe, #00f2fe)"
              >
                <i class="fas fa-user-tie"></i>
              </div>
              <span>Responsible Projects</span>
            </div>
            <div class="legend-item">
              <div
                class="legend-icon"
                style="background: linear-gradient(45deg, #a8edea, #fed6e3)"
              >
                <i class="fas fa-tasks"></i>
              </div>
              <span>Assigned Projects</span>
            </div>
            <div class="legend-item">
              <div
                class="legend-icon"
                style="background: linear-gradient(45deg, #43e97b, #38f9d7)"
              >
                <i class="fas fa-project-diagram"></i>
              </div>
              <span>Project</span>
            </div>
            <div class="legend-item">
              <div
                class="legend-icon"
                style="background: linear-gradient(45deg, #ff9a9e, #fecfef)"
              >
                <i class="fas fa-chart-bar"></i>
              </div>
              <span>Statistics</span>
            </div>
          </div>

          <div class="legend-section">
            <h7>Interactions</h7>
            <div class="legend-item">
              <span style="font-size: 0.7em">• Mouse wheel: Zoom in/out</span>
            </div>
            <div class="legend-item">
              <span style="font-size: 0.7em">• Click + drag: Pan view</span>
            </div>
            <div class="legend-item">
              <span style="font-size: 0.7em">• Click node: Show details</span>
            </div>
            <div class="legend-item">
              <span style="font-size: 0.7em"
                >• Double-click: Expand/collapse</span
              >
            </div>
          </div>
        </div>

        <!-- Info Panel -->
        <div class="info-panel" id="infoPanel">
          <h6>Node Information</h6>
          <div id="nodeInfo">Click on a node to view details</div>
        </div>

        <!-- Performance Info -->
        <div class="performance-info" id="performanceInfo">
          <span id="nodeCount">Nodes: 0</span> |
          <span id="renderTime">Render: 0ms</span> |
          <span id="fpsCounter">FPS: 0</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  class ResourceTreeVisualization {
    constructor(canvasId, apiUrl, listApiUrl) {
      this.canvas = document.getElementById(canvasId);
      this.ctx = this.canvas.getContext("2d");
      this.apiUrl = apiUrl;
      this.listApiUrl = listApiUrl;

      // View state
      this.scale = 1;
      this.panX = 0;
      this.panY = 0;
      this.minScale = 0.1;
      this.maxScale = 3;

      // Interaction state
      this.isDragging = false;
      this.lastMouseX = 0;
      this.lastMouseY = 0;
      this.selectedNode = null;
      this.hoveredNode = null;

      // Data
      this.allNodes = [];
      this.visibleNodes = [];
      this.searchQuery = "";
      this.activeFilters = new Set(["all"]);
      this.selectedResourceId = "";
      this.resourceList = [];

      // Layout
      this.layoutMode = "vertical";
      this.animationEnabled = true;
      this.nodeSpacing = { x: 350, y: 130 }; // Increased spacing to prevent overlap

      // Performance
      this.lastRenderTime = 0;
      this.fps = 0;
      this.frameCount = 0;
      this.lastFpsUpdate = performance.now();

      // Colors
      this.colors = {
        resource: { start: "#667eea", end: "#764ba2" },
        pocProjects: { start: "#f093fb", end: "#f5576c" },
        responsibleProjects: { start: "#4facfe", end: "#00f2fe" },
        assignedProjects: { start: "#a8edea", end: "#fed6e3" },
        project: { start: "#43e97b", end: "#38f9d7" },
        statistics: { start: "#ff9a9e", end: "#fecfef" },
        connection: "#495057", // Darker and more visible connection lines
        text: "#2c3e50",
        hover: "#f39c12",
        selected: "#e74c3c",
      };

      this.init();
    }

    async init() {
      this.setupCanvas();
      this.setupEventListeners();
      await this.loadResourceList();
      await this.loadData();
      this.updateStats();
      this.hideLoading();
    }

    setupCanvas() {
      const container = this.canvas.parentElement;
      this.canvas.width = container.clientWidth;
      this.canvas.height = container.clientHeight;

      // High DPI support
      const dpr = window.devicePixelRatio || 1;
      const rect = this.canvas.getBoundingClientRect();

      this.canvas.width = rect.width * dpr;
      this.canvas.height = rect.height * dpr;
      this.canvas.style.width = rect.width + "px";
      this.canvas.style.height = rect.height + "px";

      this.ctx.scale(dpr, dpr);

      window.addEventListener("resize", () => {
        this.setupCanvas();
        this.draw();
      });
    }

    setupEventListeners() {
      // Canvas events
      this.canvas.addEventListener("mousedown", this.onMouseDown.bind(this));
      this.canvas.addEventListener("mousemove", this.onMouseMove.bind(this));
      this.canvas.addEventListener("mouseup", this.onMouseUp.bind(this));
      this.canvas.addEventListener("mouseleave", this.onMouseLeave.bind(this));
      this.canvas.addEventListener("wheel", this.onWheel.bind(this));
      this.canvas.addEventListener("click", this.onClick.bind(this));
      this.canvas.addEventListener("dblclick", this.onDoubleClick.bind(this));

      // Control events
      document
        .getElementById("resourceSelect")
        .addEventListener("change", this.onResourceSelect.bind(this));
      document
        .getElementById("searchInput")
        .addEventListener("input", this.onSearch.bind(this));
      document
        .getElementById("zoomIn")
        .addEventListener("click", () => this.zoom(1.2));
      document
        .getElementById("zoomOut")
        .addEventListener("click", () => this.zoom(0.8));
      document
        .getElementById("centerView")
        .addEventListener("click", this.centerView.bind(this));
      document
        .getElementById("fitView")
        .addEventListener("click", this.fitToView.bind(this));
      document
        .getElementById("collapseAll")
        .addEventListener("click", this.collapseAll.bind(this));
      document
        .getElementById("expandAll")
        .addEventListener("click", this.expandAll.bind(this));
      document
        .getElementById("layoutVertical")
        .addEventListener("click", () => this.setLayout("vertical"));
      document
        .getElementById("layoutHorizontal")
        .addEventListener("click", () => this.setLayout("horizontal"));
      document
        .getElementById("toggleAnimation")
        .addEventListener("click", this.toggleAnimation.bind(this));
      document
        .getElementById("resetView")
        .addEventListener("click", this.resetView.bind(this));

      // Filter events
      document.querySelectorAll(".filter-btn").forEach((btn) => {
        btn.addEventListener("click", this.onFilterClick.bind(this));
      });
    }

    async loadResourceList() {
      try {
        const response = await fetch(this.listApiUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        this.resourceList = await response.json();
        this.populateResourceSelect();
      } catch (error) {
        console.error("Error loading resource list:", error);
      }
    }

    populateResourceSelect() {
      const select = document.getElementById("resourceSelect");
      select.innerHTML = '<option value="">All Resources</option>';

      this.resourceList.forEach((resource) => {
        const option = document.createElement("option");
        option.value = resource.id;
        option.textContent = `${resource.name} (${resource.total_projects} projects)`;
        select.appendChild(option);
      });
    }

    async loadData() {
      try {
        let url = this.apiUrl;
        if (this.selectedResourceId) {
          url += `?resource_id=${this.selectedResourceId}`;
        }

        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        this.processData(data);
        this.layoutNodes();
        this.centerView();
        this.draw();
      } catch (error) {
        console.error("Error loading data:", error);
        this.showError(
          "Failed to load resource tree data. Please try again later."
        );
      }
    }

    processData(data) {
      this.allNodes = [];
      let nodeId = 0;

      const processNode = (item, x, y, level, parent = null) => {
        const node = {
          id: nodeId++,
          text: item.text,
          icon: item.icon,
          x: x,
          y: y,
          level: level,
          expanded: item.opened !== false,
          visible: true,
          children: [],
          parent: parent,
          type: this.getNodeType(item.text, level),
          opacity: 1,
          data: item.resource_data || {},
          originalData: item,
        };

        this.allNodes.push(node);

        if (item.children && item.children.length > 0) {
          let childY = y;
          item.children.forEach((child, index) => {
            const childNode = processNode(
              child,
              x + this.nodeSpacing.x,
              childY,
              level + 1,
              node
            );
            node.children.push(childNode);
            childY += this.nodeSpacing.y;
          });
        }

        return node;
      };

      let currentY = 0;
      data.forEach((resourceData, index) => {
        processNode(resourceData, 0, currentY, 0);
        currentY += this.getSubtreeHeight(resourceData) * this.nodeSpacing.y;
      });

      // Set initial visibility based on expanded state
      this.allNodes.forEach((node) => {
        if (node.level === 0) {
          // Root nodes are always visible
          node.visible = true;
          this.updateChildrenVisibility(node);
        }
      });

      this.applyFilters();
    }

    getSubtreeHeight(node) {
      if (!node.children || node.children.length === 0) return 1;
      return Math.max(
        1,
        node.children.reduce(
          (sum, child) => sum + this.getSubtreeHeight(child),
          0
        )
      );
    }

    getNodeType(text, level) {
      if (level === 0) return "resource";
      if (text.includes("POC Projects")) return "pocProjects";
      if (text.includes("Responsible Projects")) return "responsibleProjects";
      if (text.includes("Assigned Projects")) return "assignedProjects";
      if (text.includes("Statistics")) return "statistics";
      return "project";
    }

    layoutNodes() {
      if (this.layoutMode === "vertical") {
        this.layoutVertical();
      } else {
        this.layoutHorizontal();
      }
    }

    layoutVertical() {
      const rootNodes = this.allNodes.filter((n) => n.level === 0);
      let currentY = 60; // Start with more padding

      rootNodes.forEach((rootNode) => {
        this.layoutSubtreeVertical(rootNode, 60, currentY);
        currentY +=
          this.getVisibleSubtreeHeight(rootNode) * this.nodeSpacing.y + 40; // Reduced gap between resources
      });
    }

    layoutSubtreeVertical(node, x, y) {
      node.x = x;
      node.y = y;

      if (node.expanded && node.children.length > 0) {
        let childY = y + this.nodeSpacing.y;
        node.children.forEach((child) => {
          this.layoutSubtreeVertical(child, x + this.nodeSpacing.x, childY);
          if (child.visible) {
            childY += this.getVisibleSubtreeHeight(child) * this.nodeSpacing.y;
          }
        });
      }
    }

    layoutHorizontal() {
      const rootNodes = this.allNodes.filter((n) => n.level === 0);
      let currentX = 50;

      rootNodes.forEach((rootNode) => {
        this.layoutSubtreeHorizontal(rootNode, currentX, 50);
        currentX +=
          this.getVisibleSubtreeWidth(rootNode) * this.nodeSpacing.x + 100;
      });
    }

    layoutSubtreeHorizontal(node, x, y) {
      node.x = x;
      node.y = y;

      if (node.expanded && node.children.length > 0) {
        let childX = x + this.nodeSpacing.x;
        node.children.forEach((child) => {
          this.layoutSubtreeHorizontal(child, childX, y + this.nodeSpacing.y);
          if (child.visible) {
            childX += this.getVisibleSubtreeWidth(child) * this.nodeSpacing.x;
          }
        });
      }
    }

    getVisibleSubtreeHeight(node) {
      if (!node.expanded || !node.children.length) return 1;
      return Math.max(
        1,
        node.children
          .filter((child) => child.visible)
          .reduce((sum, child) => sum + this.getVisibleSubtreeHeight(child), 0)
      );
    }

    getVisibleSubtreeWidth(node) {
      if (!node.expanded || !node.children.length) return 1;
      return Math.max(
        1,
        node.children
          .filter((child) => child.visible)
          .reduce((sum, child) => sum + this.getVisibleSubtreeWidth(child), 0)
      );
    }

    onResourceSelect(event) {
      this.selectedResourceId = event.target.value;
      this.loadData();
    }

    onSearch(event) {
      this.searchQuery = event.target.value.toLowerCase();
      this.applyFilters();
      this.draw();
    }

    onFilterClick(event) {
      const filter = event.target.dataset.filter;

      // Remove active class from all buttons
      document
        .querySelectorAll(".filter-btn")
        .forEach((btn) => btn.classList.remove("active"));

      if (filter === "all") {
        this.activeFilters = new Set(["all"]);
        event.target.classList.add("active");
      } else {
        this.activeFilters.delete("all");
        if (this.activeFilters.has(filter)) {
          this.activeFilters.delete(filter);
        } else {
          this.activeFilters.add(filter);
          event.target.classList.add("active");
        }

        if (this.activeFilters.size === 0) {
          this.activeFilters.add("all");
          document
            .querySelector('.filter-btn[data-filter="all"]')
            .classList.add("active");
        }
      }

      this.applyFilters();
      this.draw();
    }

    applyFilters() {
      // Reset visibility
      this.allNodes.forEach((node) => {
        node.visible = true;
        node.opacity = 1;
      });

      // Apply search filter
      if (this.searchQuery) {
        this.allNodes.forEach((node) => {
          const matchesSearch = node.text
            .toLowerCase()
            .includes(this.searchQuery);
          if (!matchesSearch) {
            // Check if any parent or child matches
            const hasMatchingChild = this.hasMatchingDescendant(
              node,
              this.searchQuery
            );
            const hasMatchingParent = this.hasMatchingAncestor(
              node,
              this.searchQuery
            );

            if (!hasMatchingChild && !hasMatchingParent) {
              node.opacity = 0.3;
            }
          }
        });
      }

      // Apply role filters
      if (!this.activeFilters.has("all")) {
        this.allNodes.forEach((node) => {
          if (node.level === 0) {
            // Check if resource has projects matching active filters
            const hasMatchingProjects = this.resourceHasMatchingProjects(node);
            if (!hasMatchingProjects) {
              node.opacity = Math.min(node.opacity, 0.3);
            }
          }
        });
      }

      this.visibleNodes = this.allNodes.filter(
        (node) => node.visible && node.opacity > 0.3
      );
      this.updateStats();
    }

    resourceHasMatchingProjects(resourceNode) {
      for (let filter of this.activeFilters) {
        const hasType = resourceNode.children.some((child) => {
          if (filter === "poc" && child.type === "pocProjects") return true;
          if (filter === "responsible" && child.type === "responsibleProjects")
            return true;
          if (filter === "assigned" && child.type === "assignedProjects")
            return true;
          return false;
        });
        if (hasType) return true;
      }
      return false;
    }

    hasMatchingDescendant(node, query) {
      return node.children.some(
        (child) =>
          child.text.toLowerCase().includes(query) ||
          this.hasMatchingDescendant(child, query)
      );
    }

    hasMatchingAncestor(node, query) {
      let parent = node.parent;
      while (parent) {
        if (parent.text.toLowerCase().includes(query)) return true;
        parent = parent.parent;
      }
      return false;
    }

    draw() {
      const startTime = performance.now();

      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

      this.ctx.save();
      this.ctx.translate(this.panX, this.panY);
      this.ctx.scale(this.scale, this.scale);

      // Draw connections first
      this.allNodes.forEach((node) => {
        if (node.visible && node.expanded && node.opacity > 0.3) {
          this.drawConnections(node);
        }
      });

      // Draw nodes
      this.allNodes.forEach((node) => {
        if (node.visible && node.opacity > 0.3) {
          this.drawNode(node);
        }
      });

      this.ctx.restore();

      // Update performance metrics
      const renderTime = performance.now() - startTime;
      this.updatePerformanceInfo(renderTime);
    }

    drawConnections(node) {
      node.children.forEach((child) => {
        if (child.visible && child.opacity > 0.3) {
          this.ctx.strokeStyle = this.colors.connection;
          this.ctx.lineWidth = 3; // Thicker lines for better visibility
          this.ctx.globalAlpha = Math.min(node.opacity, child.opacity);

          this.ctx.beginPath();
          // Better connection points
          this.ctx.moveTo(node.x + 240, node.y + 22.5); // From right edge of parent, centered
          this.ctx.lineTo(child.x, child.y + 22.5); // To left edge of child, centered
          this.ctx.stroke();

          this.ctx.globalAlpha = 1;
        }
      });
    }

    drawNode(node) {
      const nodeWidth = 240; // Slightly wider nodes
      const nodeHeight = 45; // Slightly taller nodes
      const radius = 8;

      this.ctx.globalAlpha = node.opacity;

      // Get color for node type
      const colors = this.colors[node.type] || this.colors.project;

      // Create gradient
      const gradient = this.ctx.createLinearGradient(
        node.x,
        node.y,
        node.x + nodeWidth,
        node.y + nodeHeight
      );
      gradient.addColorStop(0, colors.start);
      gradient.addColorStop(1, colors.end);

      // Draw node background
      this.ctx.fillStyle = gradient;
      this.drawRoundedRect(node.x, node.y, nodeWidth, nodeHeight, radius);
      this.ctx.fill();

      // Draw border for selected/hovered nodes
      if (node === this.selectedNode) {
        this.ctx.strokeStyle = this.colors.selected;
        this.ctx.lineWidth = 3;
        this.ctx.stroke();
      } else if (node === this.hoveredNode) {
        this.ctx.strokeStyle = this.colors.hover;
        this.ctx.lineWidth = 2;
        this.ctx.stroke();
      }

      // Draw text with better positioning
      this.ctx.fillStyle = "white";
      this.ctx.font = "bold 13px Arial"; // Slightly larger font
      this.ctx.textAlign = "left";
      this.ctx.textBaseline = "middle";

      const maxTextWidth = nodeWidth - 35;
      const text = this.truncateText(node.text, maxTextWidth);
      this.ctx.fillText(text, node.x + 12, node.y + nodeHeight / 2); // Better padding

      // Draw expand/collapse indicator
      if (node.children.length > 0) {
        this.ctx.fillStyle = "white";
        this.ctx.font = "bold 16px Arial";
        this.ctx.textAlign = "center";
        const indicator = node.expanded ? "−" : "+";
        this.ctx.fillText(
          indicator,
          node.x + nodeWidth - 18,
          node.y + nodeHeight / 2
        );
      }

      this.ctx.globalAlpha = 1;
    }

    drawRoundedRect(x, y, width, height, radius) {
      this.ctx.beginPath();
      this.ctx.moveTo(x + radius, y);
      this.ctx.lineTo(x + width - radius, y);
      this.ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
      this.ctx.lineTo(x + width, y + height - radius);
      this.ctx.quadraticCurveTo(
        x + width,
        y + height,
        x + width - radius,
        y + height
      );
      this.ctx.lineTo(x + radius, y + height);
      this.ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
      this.ctx.lineTo(x, y + radius);
      this.ctx.quadraticCurveTo(x, y, x + radius, y);
      this.ctx.closePath();
    }

    truncateText(text, maxWidth) {
      this.ctx.font = "bold 12px Arial";
      if (this.ctx.measureText(text).width <= maxWidth) {
        return text;
      }

      let truncated = text;
      while (
        this.ctx.measureText(truncated + "...").width > maxWidth &&
        truncated.length > 0
      ) {
        truncated = truncated.slice(0, -1);
      }
      return truncated + "...";
    }

    // Event handlers
    onMouseDown(event) {
      this.isDragging = true;
      this.lastMouseX = event.clientX;
      this.lastMouseY = event.clientY;
      this.canvas.parentElement.classList.add("dragging");
    }

    onMouseMove(event) {
      if (this.isDragging) {
        const deltaX = event.clientX - this.lastMouseX;
        const deltaY = event.clientY - this.lastMouseY;
        this.panX += deltaX;
        this.panY += deltaY;
        this.lastMouseX = event.clientX;
        this.lastMouseY = event.clientY;
        this.draw();
      } else {
        // Check for hover
        const rect = this.canvas.getBoundingClientRect();
        const mouseX = (event.clientX - rect.left - this.panX) / this.scale;
        const mouseY = (event.clientY - rect.top - this.panY) / this.scale;

        const hoveredNode = this.getNodeAt(mouseX, mouseY);
        if (hoveredNode !== this.hoveredNode) {
          this.hoveredNode = hoveredNode;
          this.canvas.style.cursor = hoveredNode ? "pointer" : "grab";
          this.draw();
        }
      }
    }

    onMouseUp() {
      this.isDragging = false;
      this.canvas.parentElement.classList.remove("dragging");
    }

    onMouseLeave() {
      this.isDragging = false;
      this.hoveredNode = null;
      this.canvas.parentElement.classList.remove("dragging");
      this.canvas.style.cursor = "grab";
      this.draw();
    }

    onWheel(event) {
      event.preventDefault();
      const rect = this.canvas.getBoundingClientRect();
      const mouseX = event.clientX - rect.left;
      const mouseY = event.clientY - rect.top;

      const wheel = event.deltaY < 0 ? 1 : -1;
      const zoom = Math.exp(wheel * 0.1);
      this.zoomAt(mouseX, mouseY, zoom);
    }

    onClick(event) {
      const rect = this.canvas.getBoundingClientRect();
      const mouseX = (event.clientX - rect.left - this.panX) / this.scale;
      const mouseY = (event.clientY - rect.top - this.panY) / this.scale;

      const clickedNode = this.getNodeAt(mouseX, mouseY);
      if (clickedNode) {
        this.selectedNode = clickedNode;
        this.showNodeInfo(clickedNode);
        this.draw();
      } else {
        this.selectedNode = null;
        this.hideNodeInfo();
        this.draw();
      }
    }

    onDoubleClick(event) {
      const rect = this.canvas.getBoundingClientRect();
      const mouseX = (event.clientX - rect.left - this.panX) / this.scale;
      const mouseY = (event.clientY - rect.top - this.panY) / this.scale;

      const clickedNode = this.getNodeAt(mouseX, mouseY);
      if (clickedNode && clickedNode.children.length > 0) {
        clickedNode.expanded = !clickedNode.expanded;
        this.updateChildrenVisibility(clickedNode);
        this.layoutNodes();
        this.draw();
      }
    }

    updateChildrenVisibility(node) {
      if (node.children && node.children.length > 0) {
        node.children.forEach((child) => {
          if (!node.expanded) {
            // When collapsing, hide all children and their descendants
            child.visible = false;
            this.updateChildrenVisibility(child);
          } else {
            // When expanding, show direct children
            child.visible = true;
            // For grandchildren, only show if their parent is also expanded
            if (child.expanded) {
              this.updateChildrenVisibility(child);
            }
          }
        });
      }
    }

    getNodeAt(x, y) {
      const nodeWidth = 240; // Match the actual node width
      const nodeHeight = 45; // Match the actual node height

      return this.allNodes.find(
        (node) =>
          node.visible &&
          node.opacity > 0.3 &&
          x >= node.x &&
          x <= node.x + nodeWidth &&
          y >= node.y &&
          y <= node.y + nodeHeight
      );
    }

    // Control methods
    zoom(factor) {
      const centerX = this.canvas.width / 2;
      const centerY = this.canvas.height / 2;
      this.zoomAt(centerX, centerY, factor);
    }

    zoomAt(x, y, factor) {
      const newScale = Math.max(
        this.minScale,
        Math.min(this.maxScale, this.scale * factor)
      );

      if (newScale !== this.scale) {
        const worldX = (x - this.panX) / this.scale;
        const worldY = (y - this.panY) / this.scale;

        this.scale = newScale;
        this.panX = x - worldX * this.scale;
        this.panY = y - worldY * this.scale;

        this.updateZoomLevel();
        this.draw();
      }
    }

    centerView() {
      if (this.allNodes.length === 0) return;

      const bounds = this.getBounds();
      const centerX = (bounds.minX + bounds.maxX) / 2;
      const centerY = (bounds.minY + bounds.maxY) / 2;

      this.panX = this.canvas.width / 2 - centerX * this.scale;
      this.panY = this.canvas.height / 2 - centerY * this.scale;

      this.draw();
    }

    fitToView() {
      if (this.allNodes.length === 0) return;

      const bounds = this.getBounds();
      const width = bounds.maxX - bounds.minX + 400; // Add padding
      const height = bounds.maxY - bounds.minY + 200;

      const scaleX = this.canvas.width / width;
      const scaleY = this.canvas.height / height;
      this.scale = Math.max(
        this.minScale,
        Math.min(this.maxScale, Math.min(scaleX, scaleY))
      );

      this.centerView();
      this.updateZoomLevel();
    }

    getBounds() {
      if (this.allNodes.length === 0) {
        return { minX: 0, maxX: 0, minY: 0, maxY: 0 };
      }

      const visibleNodes = this.allNodes.filter(
        (n) => n.visible && n.opacity > 0.3
      );

      let minX = visibleNodes[0].x;
      let maxX = visibleNodes[0].x + 240; // Updated to match actual node width
      let minY = visibleNodes[0].y;
      let maxY = visibleNodes[0].y + 45; // Updated to match actual node height

      visibleNodes.forEach((node) => {
        minX = Math.min(minX, node.x);
        maxX = Math.max(maxX, node.x + 240); // Updated to match actual node width
        minY = Math.min(minY, node.y);
        maxY = Math.max(maxY, node.y + 45); // Updated to match actual node height
      });

      return { minX, maxX, minY, maxY };
    }

    collapseAll() {
      this.allNodes.forEach((node) => {
        if (node.level > 0) {
          node.expanded = false;
        }
      });
      this.layoutNodes();
      this.draw();
    }

    expandAll() {
      this.allNodes.forEach((node) => {
        node.expanded = true;
      });
      this.layoutNodes();
      this.draw();
    }

    setLayout(mode) {
      this.layoutMode = mode;

      // Update button states
      document
        .querySelectorAll("#layoutVertical, #layoutHorizontal")
        .forEach((btn) => {
          btn.classList.remove("active");
        });
      document
        .getElementById(`layout${mode.charAt(0).toUpperCase() + mode.slice(1)}`)
        .classList.add("active");

      this.layoutNodes();
      this.draw();
    }

    toggleAnimation() {
      this.animationEnabled = !this.animationEnabled;
      const btn = document.getElementById("toggleAnimation");
      btn.innerHTML = this.animationEnabled
        ? '<i class="fas fa-pause"></i> Enabled'
        : '<i class="fas fa-play"></i> Disabled';
      btn.classList.toggle("active", this.animationEnabled);
    }

    resetView() {
      this.scale = 1;
      this.panX = 0;
      this.panY = 0;
      this.selectedNode = null;
      this.hoveredNode = null;

      // Reset search and filters
      document.getElementById("searchInput").value = "";
      this.searchQuery = "";
      this.activeFilters = new Set(["all"]);

      // Reset filter buttons
      document
        .querySelectorAll(".filter-btn")
        .forEach((btn) => btn.classList.remove("active"));
      document
        .querySelector('.filter-btn[data-filter="all"]')
        .classList.add("active");

      this.applyFilters();
      this.layoutNodes();
      this.centerView();
      this.updateZoomLevel();
      this.hideNodeInfo();
      this.draw();
    }

    // UI update methods
    updateZoomLevel() {
      document.getElementById("zoomLevel").textContent =
        Math.round(this.scale * 100) + "%";
    }

    updateStats() {
      const totalResources = this.allNodes.filter((n) => n.level === 0).length;
      const totalProjects = this.allNodes.filter(
        (n) => n.type === "project"
      ).length;
      const visibleCount = this.visibleNodes.length;

      document.getElementById("totalResources").textContent = totalResources;
      document.getElementById("totalProjects").textContent = totalProjects;
      document.getElementById("visibleNodes").textContent = visibleCount;
    }

    updatePerformanceInfo(renderTime) {
      this.lastRenderTime = renderTime;
      this.frameCount++;

      const now = performance.now();
      if (now - this.lastFpsUpdate >= 1000) {
        this.fps = this.frameCount;
        this.frameCount = 0;
        this.lastFpsUpdate = now;

        document.getElementById(
          "nodeCount"
        ).textContent = `Nodes: ${this.allNodes.length}`;
        document.getElementById(
          "renderTime"
        ).textContent = `Render: ${Math.round(renderTime)}ms`;
        document.getElementById("fpsCounter").textContent = `FPS: ${this.fps}`;
      }
    }

    showNodeInfo(node) {
      const infoPanel = document.getElementById("infoPanel");
      const nodeInfo = document.getElementById("nodeInfo");

      let content = `<h6>${node.text}</h6>`;

      if (node.type === "resource" && node.data) {
        content += `
        <div class="info-item"><span>Total Projects:</span><span>${node.data.total_projects}</span></div>
        <div class="info-item"><span>POC Projects:</span><span>${node.data.poc_count}</span></div>
        <div class="info-item"><span>Responsible Projects:</span><span>${node.data.responsible_count}</span></div>
        <div class="info-item"><span>Assigned Projects:</span><span>${node.data.assigned_count}</span></div>
      `;
      } else if (node.type === "project") {
        content += `<div class="info-item"><span>Type:</span><span>Project</span></div>`;
      } else {
        content += `<div class="info-item"><span>Children:</span><span>${node.children.length}</span></div>`;
      }

      nodeInfo.innerHTML = content;
      infoPanel.style.display = "block";
    }

    hideNodeInfo() {
      document.getElementById("infoPanel").style.display = "none";
    }

    hideLoading() {
      document.getElementById("loadingOverlay").style.display = "none";
    }

    showError(message) {
      document.getElementById("loadingOverlay").innerHTML = `
      <div style="text-align: center; color: #e74c3c;">
        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
        <h5>Error Loading Data</h5>
        <p>${message}</p>
      </div>
    `;
    }
  }

  // Initialize the visualization
  document.addEventListener("DOMContentLoaded", function () {
    const visualization = new ResourceTreeVisualization(
      "treeCanvas",
      '{% url "resources:resource_tree" %}',
      '{% url "resources:resource_list_api" %}'
    );
  });
</script>

{% endblock %}
